{% extends "base.html" %}

{% block title %}{{ 'Edit' if case_study else 'New' }} Case Study - Admin Console{% endblock %}
{% block page_title %}{{ 'Edit' if case_study else 'New' }} Case Study{% endblock %}

{% block content %}
<div class="case-study-editor">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Case Study Details</h3>
        </div>
        <div class="form-section">
            <div class="form-group">
                <label for="caseStudyTitle" class="form-label">Title</label>
                <input type="text" id="caseStudyTitle" class="form-input" value="{{ case_study.title if case_study else '' }}" placeholder="Google Pay Case Study">
            </div>
            <div class="form-group">
                <label for="caseStudySlug" class="form-label">Slug (URL identifier)</label>
                <input type="text" id="caseStudySlug" class="form-input" value="{{ case_study.slug if case_study else '' }}" placeholder="googlepay">
                <small class="form-hint">This will be used in the URL: https://tejasvisoi.github.io/<strong>slug</strong>.html</small>
            </div>
            <div class="form-group">
                <label for="caseStudyDescription" class="form-label">Short Description</label>
                <textarea id="caseStudyDescription" class="form-textarea" rows="2" placeholder="A brief description of the case study">{{ case_study.description if case_study else '' }}</textarea>
            </div>
            <div class="form-group">
                <label for="caseStudyContent" class="form-label">Content (HTML)</label>
                <textarea id="caseStudyContent" class="form-textarea code-editor" rows="15" placeholder="<div class='case-study'>Your content here...</div>">{{ case_study.content if case_study else '' }}</textarea>
                <small class="form-hint">You can use HTML to format your case study content.</small>
            </div>
            <div class="form-group">
                <label for="caseStudyStatus" class="form-label">Status</label>
                <select id="caseStudyStatus" class="form-select">
                    <option value="draft" {% if case_study and case_study.status == 'draft' %}selected{% endif %}>Draft</option>
                    <option value="published" {% if case_study and case_study.status == 'published' %}selected{% endif %}>Published</option>
                </select>
            </div>
        </div>
    </div>

    <div class="action-buttons">
        <button type="button" class="btn btn-primary" id="saveCaseStudy">
            <i class="fas fa-save"></i> Save Case Study
        </button>
        {% if case_study %}
        <button type="button" class="btn btn-secondary" id="previewCaseStudy">
            <i class="fas fa-eye"></i> Preview
        </button>
        {% endif %}
        <a href="{{ url_for('case_studies') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Case Studies
        </a>
    </div>
</div>

<style>
    .case-study-editor {
        display: grid;
        gap: 1.5rem;
    }

    .form-section {
        display: grid;
        gap: 1rem;
    }

    .form-hint {
        display: block;
        margin-top: 0.25rem;
        color: #64748b;
        font-size: 0.75rem;
    }

    .code-editor {
        font-family: monospace;
        font-size: 0.875rem;
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        padding: 1rem 0;
        border-top: 1px solid #e2e8f0;
        margin-top: 1rem;
    }

    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
        }
    }
</style>

<script>
    // Auto-generate slug from title
    document.getElementById('caseStudyTitle').addEventListener('input', function() {
        // Only generate slug if it's empty or hasn't been manually edited
        const slugField = document.getElementById('caseStudySlug');
        if (!slugField.value || slugField._autoGenerated) {
            const slug = this.value
                .toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-+|-+$/g, '');
            
            slugField.value = slug;
            slugField._autoGenerated = true;
        }
    });

    // Mark slug as manually edited
    document.getElementById('caseStudySlug').addEventListener('input', function() {
        this._autoGenerated = false;
    });

    // Save case study
    document.getElementById('saveCaseStudy').addEventListener('click', async function() {
        const button = this;
        const originalText = showLoading(button);

        try {
            const title = document.getElementById('caseStudyTitle').value.trim();
            const slug = document.getElementById('caseStudySlug').value.trim();
            
            if (!title || !slug) {
                showAlert('Title and slug are required', 'error');
                hideLoading(button, originalText);
                return;
            }

            const caseStudyData = {
                title: title,
                slug: slug,
                description: document.getElementById('caseStudyDescription').value.trim(),
                content: document.getElementById('caseStudyContent').value.trim(),
                status: document.getElementById('caseStudyStatus').value
            };

            {% if case_study %}
            // Update existing case study
            const response = await apiCall('/case-studies/{{ case_study.id }}/edit', {
                method: 'POST',
                body: JSON.stringify(caseStudyData)
            });
            
            showAlert('Case study updated successfully!', 'success');
            {% else %}
            // Create new case study
            const response = await apiCall('/case-studies/new', {
                method: 'POST',
                body: JSON.stringify(caseStudyData)
            });
            
            showAlert('Case study created successfully!', 'success');
            
            // Redirect to edit page after creation
            setTimeout(() => {
                window.location.href = `/case-studies/${response.id}/edit`;
            }, 1000);
            {% endif %}
        } catch (error) {
            console.error('Error saving case study:', error);
        } finally {
            hideLoading(button, originalText);
        }
    });

    {% if case_study %}
    // Preview case study
    document.getElementById('previewCaseStudy').addEventListener('click', function() {
        const slug = document.getElementById('caseStudySlug').value;
        if (slug) {
            window.open(`https://tejasvisoi.github.io/${slug}.html`, '_blank');
        } else {
            showAlert('Please set a slug first', 'error');
        }
    });
    {% endif %}
</script>
{% endblock %}